{%- assign init_variant = product.selected_or_first_available_variant -%}
{%- assign initial_discount_data = init_variant.metafields.custom.discount_options | default: '[]' -%}

<div id="discountTableWrapper-{{ section.id }}" class="discount-table-wrapper" style="display:none;">
  <div class="discount-table-header">
    <h3>Volume Discounts</h3>
    <p class="discount-subtitle">Save more when you buy in bulk!</p>
  </div>

  <div id="discountTable-{{ section.id }}" class="discount-table-container">
    <table class="discount-table">
      <thead>
        <tr id="discountTableHead-{{ section.id }}"></tr>
      </thead>
      <tbody id="discountTableBody-{{ section.id }}"></tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const tableHead = document.getElementById("discountTableHead-{{ section.id }}");
  const tableBody = document.getElementById("discountTableBody-{{ section.id }}");
  const wrapper  = document.getElementById("discountTableWrapper-{{ section.id }}");

  // Build a plain JS object with every variant's JSON (no double encoding)
  const variantsDiscountData = {
    {% for variant in product.variants %}
      "{{ variant.id }}": {{ variant.metafields.custom.discount_options | default: '[]' }}{% unless forloop.last %},{% endunless %}
    {% endfor %}
  };

  // Initial state
  let currentVariantId = String({{ init_variant.id }});
  let currentDiscountData = {{ initial_discount_data }};

  function buildHeader(keys) {
    tableHead.innerHTML = '';
    keys.forEach(k => {
      const th = document.createElement('th');
      th.textContent = k;
      tableHead.appendChild(th);
    });
  }

  function buildBody(keys, rows) {
    tableBody.innerHTML = '';
    rows.forEach((rowObj, idx) => {
      const tr = document.createElement('tr');
      tr.className = `discount-row ${idx % 2 === 0 ? 'even' : 'odd'}`;

      // Optional highlight by discount key
      const discountKey = keys.find(k => k.toLowerCase().includes('discount'));
      if (discountKey && rowObj[discountKey]) {
        const pct = parseInt(String(rowObj[discountKey]).replace(/[^\d]/g, '')) || 0;
        if (pct >= 25) tr.classList.add('high-discount');
        else if (pct >= 10) tr.classList.add('medium-discount');
      }

      keys.forEach(k => {
        const td = document.createElement('td');
        const val = rowObj[k] == null ? '' : rowObj[k];
        td.textContent = typeof val === 'object' ? JSON.stringify(val) : String(val);
        tr.appendChild(td);
      });

      tableBody.appendChild(tr);
    });
  }

  function renderTable(data) {
    if (!Array.isArray(data) || data.length === 0) {
      wrapper.style.display = 'none';
      return;
    }
    const keys = Object.keys(data[0]);
    if (keys.length === 0) {
      wrapper.style.display = 'none';
      return;
    }
    buildHeader(keys);
    buildBody(keys, data);
    wrapper.style.display = 'block';
  }

  function updateForVariantId(variantId) {
    const key = String(variantId);
    const data = variantsDiscountData[key];
    if (Array.isArray(data) && data.length) {
      currentVariantId = key;
      currentDiscountData = data;
      renderTable(currentDiscountData);
    } else {
      // No data for this variant â€” hide table
      wrapper.style.display = 'none';
    }
  }

  // Listen to multiple common theme events
  document.addEventListener('variant:update', (e) => {
    const id = e?.detail?.resource?.id;
    if (id) updateForVariantId(id);
  });
  document.addEventListener('product:variant:change', (e) => {
    const id = e?.detail?.variant?.id || e?.detail?.variantId;
    if (id) updateForVariantId(id);
  });
  document.addEventListener('variant:changed', (e) => {
    const id = e?.detail?.variant?.id || e?.detail?.variantId;
    if (id) updateForVariantId(id);
  });

  // Fallback: watch the hidden variant id input inside product forms
  document.querySelectorAll('form[action*="/cart/add"] [name="id"]').forEach((input) => {
    input.addEventListener('change', () => {
      if (input.value) updateForVariantId(input.value);
    });
  });

  // Initial render
  renderTable(currentDiscountData);
});
</script>

{% schema %}
{
  "name": "Discount Options",
  "settings": [],
  "presets": [
    {
      "category": "Custom Block",
      "name": "Discount Options"
    }
  ]
}
{% endschema %}
