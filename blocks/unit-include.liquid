<div id="variantAdditionalInfoWrapper-{{ section.id }}">
  {%- assign init_variant = product.selected_or_first_available_variant -%}
  <div id="variantAdditionalInfo-{{ section.id }}">
    {{ init_variant.metafields.custom.unit_include }}
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const quantitySelector = document.querySelector(".quantity-selector");
    if (!quantitySelector) return; // stop if quantity selector not found

    const customquantityInput = quantitySelector.querySelector("input[name='quantity']");
    const minusBtn = quantitySelector.querySelector("button[name='minus']");
    const plusBtn = quantitySelector.querySelector("button[name='plus']");
    const infoBox = document.getElementById("variantAdditionalInfo-{{ section.id }}");

    // Safe fallback value if metafield is missing
    let unitInclude = {{ init_variant.metafields.custom.unit_include | default: 1 | json }};

    function updateVariantInfo() {
      const qty = parseInt(customquantityInput.value) || 1;
      const result = unitInclude * qty;
      infoBox.textContent = `You will receive ${result} units`;
    }

    // Input change (manual typing)
    customquantityInput.addEventListener("input", updateVariantInfo);

    // +/- buttons (use timeout to wait until Shopify updates quantity input)
    minusBtn?.addEventListener("click", () => setTimeout(updateVariantInfo, 0));
    plusBtn?.addEventListener("click", () => setTimeout(updateVariantInfo, 0));

    // Listen for variant change event (supported by Dawn & most modern themes)
    document.addEventListener("variant:changed", (event) => {
      const newVariant = event.detail?.variant;
      if (!newVariant) return;
      // Update unitInclude if metafield exists on new variant
      unitInclude = newVariant?.metafields?.custom?.unit_include ?? 1;
      updateVariantInfo();
    });

    // Run once on load
    updateVariantInfo();
  });
</script>

{% schema %}
{
  "name": "Unit Include",
  "settings": [],
  "presets": [
    {
      "category": "Custom Block",
      "name": "Unit Include"
    }
  ]
}
{% endschema %}
